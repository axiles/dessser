# Configuration

VERSION = @PACKAGE_VERSION@

OCAMLOPT = OCAMLRUNPARAM= ocamlfind ocamlopt
OCAMLC   = OCAMLRUNPARAM= ocamlfind ocamlc
OCAMLDEP = OCAMLRUNPARAM= ocamlfind ocamldep
CPPO = cppo
QTEST = qtest
WARNS = -w -40-58+27

OCAMLOPTFLAGS = @OCAMLOPTFLAGS@ $(WARNS) -annot
OCAMLCFLAGS =   @OCAMLCFLAGS@   $(WARNS)

ifdef NDEBUG
OCAMLOPTFLAGS += -noassert -O2
else
OCAMLOPTFLAGS += -g
endif

PACKAGES = \
	batteries,parsercombinator,stdint,qcheck

META_REQUIRES = \
	findlib,$(PACKAGES)

INSTALLED_BIN = \
	src/dessserc

INSTALLED_LIB = \
	dessser.cmxa \
	dessser.cma \
	dessser.a \
	$(filter %.cmi, $(LIBDESSSER_SOURCES:.ml=.cmi)) \
	$(filter %.cmx, $(LIBDESSSER_SOURCES:.ml=.cmx)) \
	$(filter %.cmo, $(LIBDESSSER_SOURCES:.ml=.cmo))

INSTALLED_HEADERS = \
	src/dessser/Bytes.h \
	src/dessser/Map.h \
	src/dessser/Mask.h \
	src/dessser/Pair.h \
	src/dessser/Pointer.h \
	src/dessser/List.h \
	src/dessser/runtime.h \
	src/dessser/SList.h \
	src/dessser/typedefs.h \
	src/dessser/Vec.h

INSTALLED = \
	$(INSTALLED_LIB) \
	$(INSTALLED_HEADERS) \
	$(INSTALLED_BIN) \
	META

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir ?= @bindir@

all: $(INSTALLED) examples

# Generic rules

.SUFFIXES: .ml .mli .mlo .cmi .cmx .cmo .cmt .html .adoc
.PHONY: \
  clean distclean all dep doc examples \
  check unit-check examples-check cpp-check \
  install uninstall reinstall

%.cmi: %.mli
	@echo 'Compiling $@ (interface)'
	$(OCAMLOPT) $(OCAMLOPTFLAGS) -I $(dir $@) -package '$(PACKAGES)' -c $<

%.cmx %.cmt: %.ml
	@echo 'Compiling $@'
	$(OCAMLOPT) $(OCAMLOPTFLAGS) -I $(dir $@) -package '$(PACKAGES)' -c $<

%.cmo: %.ml
	@echo 'Compiling $@'
	$(OCAMLC) $(OCAMLCFLAGS) -I $(dir $@) -package '$(PACKAGES)' -c $<

%.ml: %.mlo
	@echo "Preprocessing $@"
	$(CPPO) $< -o $@

# Documentation

%.html: %.adoc
	@echo 'Building documentation $@'
	asciidoc -a data-uri -a icons -a toc -a max-width=55em --theme volnitsky -o $@ $<

doc:

LIBDESSSER_SOURCES = \
	src/DessserTools.ml \
	src/DessserFloatTools.ml \
	src/DessserCompilConfig.ml \
	src/DessserTypes.ml \
	src/DessserExpressions.ml \
	src/DessserMasks.ml \
	src/Dessser.ml \
	src/DessserDSTools_FragmentsCPP.ml \
	src/DessserDSTools_FragmentsOCaml.ml \
	src/DessserDSTools.ml \
	src/SExpr.ml \
	src/RowBinary.ml \
	src/RamenRingBuffer.ml \
	src/DevNull.ml \
	src/BackEndCLike.ml \
	src/BackEndCPP.ml \
	src/BackEndOCaml.ml \
	src/HeapValue.ml \
	src/DessserOCamlBackendHelpers.ml \
	src/DessserQCheck.ml

EXAMPLES_SOURCES = \
	examples/simplest.ml \
	examples/manual_codegen.ml

TESTONLY_SOURCES =

SOURCES = $(sort \
	$(LIBDESSSER_SOURCES) \
	$(EXAMPLES_SOURCES) \
	$(TESTONLY_SOURCES) \
)

# Dependencies

dep:
	@$(RM) .depend
	@$(MAKE) .depend

.depend: $(SOURCES)
	@$(OCAMLDEP) -I src -package '$(PACKAGES)' $(filter %.ml, $(LIBDESSSER_SOURCES)) $(filter %.mli, $(LIBDESSSER_SOURCES)) >> $@

include .depend

# Compile dessser lib

src/dessser.cmxa: $(LIBDESSSER_SOURCES:.ml=.cmx)
	@echo 'Linking runtime library $@ (native)'
	$(OCAMLOPT) $(OCAMLOPTFLAGS) -I src -a $(filter %.cmx, $^) -o $@

src/dessser.cma: $(LIBDESSSER_SOURCES:.ml=.cmo)
	@echo 'Linking runtime library $@ (bytecode)'
	$(OCAMLC) $(OCAMLCFLAGS) -I src -a $(filter %.cmo, $^) -o $@

src/dessser.a: src/dessser.cmxa

dessser.cmxa: src/dessser.cmxa
	@ln -f $< $@

dessser.cma: src/dessser.cma
	@ln -f $< $@

dessser.a: src/dessser.a
	@ln -f $< $@

# Command line tool

src/dessserc: src/dessser.cmxa src/dessserc.ml
	$(OCAMLOPT) $(OCAMLOPTFLAGS) -I src -linkpkg -package '$(PACKAGES),cmdliner' $^ -o $@

# Compile examples

examples: $(EXAMPLES_SOURCES:%.ml=%.opt)

examples/simplest.opt: src/dessser.cmxa examples/simplest.ml
	$(OCAMLOPT) $(OCAMLOPTFLAGS) -I src -linkpkg -package '$(PACKAGES)' $^ -o $@

examples/manual_codegen.opt: src/dessser.cmxa examples/manual_codegen.ml
	$(OCAMLOPT) $(OCAMLOPTFLAGS) -I src -linkpkg -package '$(PACKAGES)' $^ -o $@

# Generated sources

META: Makefile
	@echo 'Building findlib configuration (META) for Ramen'
	@echo 'description = "(de)serializer generator"' > $@
	@echo 'version = "$(VERSION)"' >> $@
	@echo 'archive(native) = "dessser.cmxa"' >> $@
	@echo 'archive(byte) = "dessser.cma"' >> $@
	@echo 'requires = "$(META_REQUIRES)"' >> $@

src/DessserCompilConfig.ml: Makefile
	@echo '(* Generated by Makefile - edition is futile *)' > $@
	@echo 'let ocaml_version = "@OCAMLVERSION@"' >> $@
	@echo 'let build_path = "$(PATH)"' >> $@
	@echo 'let ocamlpath = "$(OCAMLPATH)"' >> $@
	@echo 'let cpp_compiler = "@CXX@"' >> $@
	@echo 'let build_date = "$(shell date -R)"' >> $@
	@echo 'let build_host = "$(shell hostname)"' >> $@
	@echo 'let version = "$(VERSION)"' >> $@

# Tests

TESTABLE_SOURCES = \
	src/DessserTools.ml \
	src/DessserTypes.ml \
	src/DessserExpressions.ml \
	src/DessserMasks.ml \
	src/BackEndCPP.ml \
	src/DessserQCheck.ml \
	src/DessserOCamlBackendHelpers.ml

LINKED_FOR_TESTS = \
	src/DessserFloatTools.ml \
	src/DessserTools.ml \
	src/DessserTypes.ml \
	src/DessserExpressions.ml \
	src/DessserMasks.ml \
	src/Dessser.ml \
	src/DessserDSTools_FragmentsCPP.ml \
	src/DessserDSTools_FragmentsOCaml.ml \
	src/DessserDSTools.ml \
	src/DessserOCamlBackendHelpers.ml \
	src/BackEndCLike.ml \
	src/BackEndCPP.ml \
	src/BackEndOCaml.ml \
	src/SExpr.ml \
	src/RowBinary.ml \
	src/RamenRingBuffer.ml \
	src/HeapValue.ml \
	src/DessserQCheck.ml

src/all_tests.ml: $(TESTABLE_SOURCES)
	@echo 'Generating unit tests into $@'
	$(QTEST) --shuffle -o $@ extract $^

all_tests.opt: \
		$(filter %.cmx,$(LINKED_FOR_TESTS:.ml=.cmx)) \
		src/all_tests.ml
	@echo 'Building unit tests into $@'
	$(OCAMLOPT) $(OCAMLOPTFLAGS) -linkpkg -package $(PACKAGES) -package qcheck -I src $(filter %.cmx, $^) $(filter %.ml, $^) -o $@

unit-check: all_tests.opt
	@echo 'Running unit tests...'
	@ulimit -n 5000 ;\
	 TZ=CET OCAMLRUNPARAM=b ./all_tests.opt -bt

examples-check: examples/simplest.opt examples/manual_codegen.opt
	@ulimit -n 5000
	@examples/simplest.opt ocaml && /tmp/simplest_gen.opt && echo "simplest ocaml OK"
	@examples/simplest.opt c++ && /tmp/simplest_gen.exe && echo "simplest c++ OK"
	@examples/manual_codegen.opt ocaml && \
	 examples/rowbinary2sexpr.opt < udp_v30.chb > examples/rowbinary2sexpr.opt.out && \
	 diff examples/rowbinary2sexpr.opt.out examples/rowbinary2sexpr.expected && \
	 echo "manual_codegen ocaml OK"
	@examples/manual_codegen.opt c++ && \
	 examples/rowbinary2sexpr.exe < udp_v30.chb > examples/rowbinary2sexpr.exe.out && \
	 diff examples/rowbinary2sexpr.exe.out examples/rowbinary2sexpr.expected && \
	 echo "manual_codegen c++ OK"
	@echo SUCCESS

src/cpp_tests: src/cpp_tests.cc src/dessser/runtime.h
	g++ -std=c++17 -g -O0 -W -Wall -I src $< -o $@

cpp-check: src/cpp_tests
	src/cpp_tests

testdb-dump: src/dessserc
	src/dessserc --input=ringbuf --language=OCaml --output-enc=s-expression --target=dump --value-schema string --key-schema u32 -o $@

testdb-load: src/dessserc
	src/dessserc --input=s-expression --language=OCaml --output-enc=ringbuf --target=load --value-schema string --key-schema u32 -o $@

dump-load-check: testdb-dump testdb-load testdb.dump
	@ENVNAME=/tmp/testdb ;\
	 rm -rf $$ENVNAME ;\
	 mkdir -p $$ENVNAME ;\
	 ./testdb-load --kv-delim : $$ENVNAME < testdb.dump ;\
	 ./testdb-dump --kv-delim : $$ENVNAME | sort > /tmp/testdb.dump ;\
	 diff /tmp/testdb.dump testdb.dump

check: unit-check examples-check cpp-check dump-load-check

# Installation

install: $(INSTALLED)
	ocamlfind install dessser $(INSTALLED)

uninstall:
	ocamlfind remove dessser

reinstall: uninstall install

# Packaging

# Cleaning

clean:
	@echo 'Cleaning'
	@$(RM) src/*.s src/*.annot src/*.cmt src/*.cmti src/*.o src/*.opt src/*.byte
	@$(RM) src/*.cmx src/*.cmo src/*.cmxa src/*.cma src/*.cmxs src/*.cmi src/*.a
	@$(RM) examples/*.s examples/*.annot examples/*.cmt examples/*.cmti examples/*.o examples/*.opt examples/*.byte
	@$(RM) examples/*.cmx examples/*.cmo examples/*.cmxa examples/*.cma examples/*.cmxs examples/*.cmi examples/*.a
	@$(RM) all_tests.* src/all_tests.ml
	@$(RM) *.opt perf.data* gmon.out .depend

distclean: clean
	@echo 'Cleaning all build files'
	@$(RM) META DessserCompilConfig.ml
